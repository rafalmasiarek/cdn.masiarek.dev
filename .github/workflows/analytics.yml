name: "Pages: Analytics JSON"

on:
    workflow_dispatch: {}
    schedule:
        - cron: "7 * * * *"

permissions:
    contents: write

concurrency:
    group: gh-pages
    cancel-in-progress: false

jobs:
    analytics:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout source
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Install root deps
              run: npm install --no-audit --no-fund

            - name: Checkout gh-pages into ./public (create if missing)
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  set -euo pipefail

                  rm -rf public
                  mkdir -p public
                  cd public

                  git init
                  git remote add origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"

                  if git fetch origin gh-pages --depth 1; then
                    git checkout -B gh-pages FETCH_HEAD
                  else
                    git checkout --orphan gh-pages
                    git rm -rf . >/dev/null 2>&1 || true
                    mkdir -p _index
                    echo "gh-pages initialized" > _index/.init
                  fi

                  mkdir -p _index
                  touch .nojekyll

                  if [[ -n "${{ vars.CDN_CUSTOM_DOMAIN }}" ]]; then
                    echo "${{ vars.CDN_CUSTOM_DOMAIN }}" > CNAME
                  fi

            - name: Fetch + write analytics JSONs
              env:
                  CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
                  CF_ZONE_TAG: ${{ secrets.CF_ZONE_TAG }}
                  CDN_CUSTOM_DOMAIN: ${{ vars.CDN_CUSTOM_DOMAIN }}
              run: |
                  set -euo pipefail
                  node tools/fetch-analytics.mjs

            - name: Commit & push if changed
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  set -euo pipefail
                  cd public

                  touch .nojekyll
                  if [[ -n "${{ vars.CDN_CUSTOM_DOMAIN }}" ]]; then
                    echo "${{ vars.CDN_CUSTOM_DOMAIN }}" > CNAME
                  fi

                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

                  git add -A
                  git diff --cached --quiet && exit 0
                  git commit -m "pages(analytics): update"
                  git push -u origin gh-pages

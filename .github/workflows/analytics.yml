name: Analytics (Cloudflare) -> Pages JSON

on:
    schedule:
        - cron: "7 * * * *"
    workflow_dispatch: {}

permissions:
    contents: write

jobs:
    analytics:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout source
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Install root deps
              run: npm install --no-audit --no-fund

            - name: Checkout gh-pages into ./public
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  set -euo pipefail
                  rm -rf public
                  git clone --branch gh-pages --depth 1 "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git" public || true
                  mkdir -p public/_index

            - name: Fetch + write analytics JSONs
              env:
                  CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
                  CF_ZONE_TAG: ${{ secrets.CF_ZONE_TAG }}
                  CF_HOSTNAME: ${{ vars.CF_HOSTNAME }}
              run: |
                  set -euo pipefail
                  node tools/fetch-analytics.mjs

            - name: Commit & push if changed
              run: |
                  set -euo pipefail
                  cd public
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git add -A
                  git diff --cached --quiet && exit 0
                  git commit -m "analytics: update"
                  git push origin gh-pages

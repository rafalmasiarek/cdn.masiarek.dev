name: "Pages: Deploy UI"

on:
    push:
        branches: ["main"]
        paths:
            - "pages/**"
    workflow_dispatch: {}

permissions:
    contents: write

concurrency:
    group: gh-pages
    cancel-in-progress: false

jobs:
    ui:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout source
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Checkout gh-pages into ./public (create if missing)
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  set -euo pipefail

                  rm -rf public
                  mkdir -p public
                  cd public

                  git init
                  git remote add origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"

                  if git fetch origin gh-pages --depth 1; then
                    git checkout -B gh-pages FETCH_HEAD
                  else
                    git checkout --orphan gh-pages
                    git rm -rf . >/dev/null 2>&1 || true
                    mkdir -p _index
                    echo "gh-pages initialized" > _index/.init
                  fi

                  mkdir -p _index
                  touch .nojekyll

            - name: Copy UI files to gh-pages root
              env:
                  CDN_CUSTOM_DOMAIN: ${{ vars.CDN_CUSTOM_DOMAIN }}
              run: |
                  set -euo pipefail

                  cp -f pages/index.html public/index.html
                  cp -f pages/app.js public/app.js
                  cp -f pages/styles.css public/styles.css

                  touch public/.nojekyll

                  if [[ -n "${CDN_CUSTOM_DOMAIN:-}" ]]; then
                    echo "${CDN_CUSTOM_DOMAIN}" > public/CNAME
                  fi

            - name: Inject build fingerprint into index.html
              run: |
                  set -euo pipefail
                  BUILD="${GITHUB_SHA::8}"
                  sed -i "s/__BUILD__/${BUILD}/g" public/index.html

            - name: Commit & push if changed
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  set -euo pipefail
                  cd public

                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

                  git add -A
                  git diff --cached --quiet && exit 0
                  git commit -m "pages(ui): deploy"
                  git push -u origin gh-pages

            - name: Purge Cloudflare cache (index.html, styles.css, app.js)
              if: always()
              env:
                  CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
                  CF_ZONE_ID: ${{ secrets.CF_ZONE_ID }}
                  CDN_CUSTOM_DOMAIN: ${{ vars.CDN_CUSTOM_DOMAIN }}
              run: |
                  set -euo pipefail
                  : "${CDN_CUSTOM_DOMAIN:?Missing vars.CDN_CUSTOM_DOMAIN}"
                  : "${CF_API_TOKEN:?Missing secrets.CF_API_TOKEN}"
                  : "${CF_ZONE_ID:?Missing secrets.CF_ZONE_ID}"

                  BASE="https://${CDN_CUSTOM_DOMAIN}"
                  curl -fsS -X POST "https://api.cloudflare.com/client/v4/zones/${CF_ZONE_ID}/purge_cache" \
                    -H "Authorization: Bearer ${CF_API_TOKEN}" \
                    -H "Content-Type: application/json" \
                    --data "$(jq -n --arg b "$BASE" '{
                      files: [
                        ($b + "/"),
                        ($b + "/index.html"),
                        ($b + "/styles.css"),
                        ($b + "/app.js")
                      ]
                    }')"

name: Publish Tagged Release to Pages

on:
  push:
    tags:
      - "*@*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to publish (e.g. vinyl-loader@1.0.1)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Parse tag
        id: tag
        run: |
          set -euo pipefail

          # For manual runs, always prefer the provided input tag.
          TAG="${{ inputs.tag }}"
          if [[ -z "$TAG" ]]; then
            TAG="${GITHUB_REF_NAME}"
          fi

          if [[ "$TAG" != *"@"* ]]; then
            echo "Invalid tag '$TAG'. Expected format: <package>@<version>, e.g. vinyl-loader@1.0.1"
            exit 1
          fi

          PKG="${TAG%@*}"
          VER="${TAG#*@}"

          echo "pkg=$PKG" >> $GITHUB_OUTPUT
          echo "ver=$VER" >> $GITHUB_OUTPUT

      - name: Validate package exists
        run: |
          set -euo pipefail
          PKG="${{ steps.tag.outputs.pkg }}"
          test -d "packages/$PKG" || (echo "Package '$PKG' not found under packages/." && exit 1)

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Build package
        run: |
          set -euo pipefail
          PKG="${{ steps.tag.outputs.pkg }}"
          cd "packages/$PKG"
          npm install --no-audit --no-fund
          npm run build

      - name: Checkout gh-pages branch into ./public (create if missing)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          rm -rf public
          mkdir -p public
          cd public

          git init
          git remote add origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"

          # If gh-pages exists, fetch & checkout it. Otherwise create an orphan gh-pages branch.
          if git fetch origin gh-pages --depth 1; then
            git checkout -B gh-pages FETCH_HEAD
          else
            git checkout --orphan gh-pages
            git rm -rf . >/dev/null 2>&1 || true
            mkdir -p _index
            echo "gh-pages initialized" > _index/.init
          fi

          echo "== public repo status =="
          pwd
          git branch --show-current
          git status

      - name: Generate manifests, update channels, update indexes, bundle manifest, and UI
        env:
          PKG: ${{ steps.tag.outputs.pkg }}
          VER: ${{ steps.tag.outputs.ver }}
          SHA: ${{ github.sha }}
          CDN_BASE_URL: ${{ vars.CDN_BASE_URL }}
          CDN_CUSTOM_DOMAIN: ${{ vars.CDN_CUSTOM_DOMAIN }}
        run: |
          set -euo pipefail

          if [[ "$VER" == *"-"* ]]; then
            CHANNEL="beta"
          else
            CHANNEL="stable"
          fi

          BUILT_AT="$(date -u +%FT%TZ)"
          PKG_DIR="public/$PKG"
          VERSION_DIR="$PKG_DIR/v$VER"
          LATEST_DIR="$PKG_DIR/@latest"
          STABLE_DIR="$PKG_DIR/@stable"
          BETA_DIR="$PKG_DIR/@beta"

          mkdir -p "$VERSION_DIR" "$LATEST_DIR" "$STABLE_DIR" "$BETA_DIR" "public/_index"

          # Copy dist -> versioned folder (immutable)
          rm -rf "$VERSION_DIR"/*
          cp -r "packages/$PKG/dist/"* "$VERSION_DIR/"

          # Update @latest always
          rm -rf "$LATEST_DIR"/*
          cp -r "packages/$PKG/dist/"* "$LATEST_DIR/"

          # Update channel pointers
          if [[ "$CHANNEL" == "stable" ]]; then
            rm -rf "$STABLE_DIR"/*
            cp -r "packages/$PKG/dist/"* "$STABLE_DIR/"
          else
            rm -rf "$BETA_DIR"/*
            cp -r "packages/$PKG/dist/"* "$BETA_DIR/"
          fi

          # Build manifest with SRI
          node -e "import {computeSriMap} from './tools/sri.mjs'; import fs from 'node:fs';
          const files = computeSriMap('$VERSION_DIR');
          const manifest = {
            package: process.env.PKG,
            version: 'v' + process.env.VER,
            channel: '$CHANNEL',
            built_at: '$BUILT_AT',
            commit: process.env.SHA,
            files
          };
          fs.writeFileSync('$VERSION_DIR/manifest.json', JSON.stringify(manifest, null, 2)+'\\n');
          fs.writeFileSync('$LATEST_DIR/manifest.json', JSON.stringify(manifest, null, 2)+'\\n');
          if ('$CHANNEL'==='stable') fs.writeFileSync('$STABLE_DIR/manifest.json', JSON.stringify(manifest, null, 2)+'\\n');
          if ('$CHANNEL'==='beta') fs.writeFileSync('$BETA_DIR/manifest.json', JSON.stringify(manifest, null, 2)+'\\n');
          "

          # Update indexes
          node -e "import {updateIndexes} from './tools/update-index.mjs';
          updateIndexes({
            publicDir: 'public',
            pkg: process.env.PKG,
            version: 'v' + process.env.VER,
            channel: '$CHANNEL',
            builtAt: '$BUILT_AT'
          });"

          # Build bundle manifest
          node -e "import {buildBundleManifest} from './tools/build-bundle-manifest.mjs';
          buildBundleManifest({ publicDir: 'public', baseUrl: process.env.CDN_BASE_URL || '', builtAt: '$BUILT_AT' });"

          # Copy pages UI
          cp -f pages/index.html public/index.html
          cp -f pages/app.js public/app.js
          cp -f pages/styles.css public/styles.css

          touch public/.nojekyll

          # Custom domain for GitHub Pages (optional)
          if [[ -n "${CDN_CUSTOM_DOMAIN:-}" ]]; then
            echo "${CDN_CUSTOM_DOMAIN}" > public/CNAME
          fi

      - name: Publish to gh-pages (commit & push)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          cd public

          echo "== final sanity =="
          pwd
          git branch --show-current
          git status

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A
          git commit -m "publish: ${{ steps.tag.outputs.pkg }}@${{ steps.tag.outputs.ver }}" || true
          git push -u origin gh-pages
